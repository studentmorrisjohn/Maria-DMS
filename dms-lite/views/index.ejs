<!DOCTYPE html>
<html>

    <head>
       
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Project Maria</title>
        <%- include ('partials/head') %>

        <!-- Leaflet CSS-->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
        integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
        crossorigin=""/>

        <!--Leaflet JavaScript-->
        <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
        integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
        crossorigin=""></script>

        <!-- SOCKET IO -->
	    <script src="/socket.io/socket.io.js"></script>

    </head>


    <body>
        <div class="bg-div">
            <%- include ('partials/nav' , {page:"home"}) %>
            <div id ="info-modal">
                <div class="modal_row">
                    <span class="modal_category">Client ID: </span><span class="modal_value" id="modal_clientId"> Loading Data </span> 
                </div>
                <div class="modal_row">
                    <span class="modal_category">Location: </span><span class="modal_value" id="modal_location"> Loading Data </span> 
                </div>
                <div class="modal_row">
                    <span class="modal_category">Name: </span><span class="modal_value" id="modal_rescuee_name"> Loading Data </span>
                </div>
                <div class="modal_row">
                    <span class="modal_category">Phone Number: </span><span class="modal_value" id="modal_phone"> Loading Data </span> 
                </div>
                <hr>
                <div class="modal_row">
                    <span class="modal_category">Type: </span><span class="modal_value red" id="modal_emergency"> Loading Data </span> 
                </div>
                <div class="modal_row">
                    <span class="modal_category">Needs: </span><span class="modal_value" id="modal_needs"> Loading Data </span>
                </div>
                <div class="modal_row">
                    <span class="modal_category">Dangers: </span><span class="modal_value" id="modal_dangers"> Loading Data </span>
                </div>
                <hr >
                <div class="modal_row">
                    <span class="modal_category">#of People: </span><span class="modal_value" id="modal_noOfPeople"> Loading Data</span>
                </div>
                <div class="modal_row">
                    <span class="modal_category">Immobile: </span><span class="modal_value" id="modal_immobile"> Loading Data</span>
                </div>
                <div class="modal_row">
                    <span class="modal_category">Message: </span><span class="modal_value" id="modal_message"> Loading Data</span>
                </div>
                <div class="modal_status">
                    <span class="modal_status_text"> RESCUERS SENT </span>
                </div>
            </div>
            <div id="map"></div>
            <%- include ('partials/footer') %>
        </div>
	    
        

        
        <script>

            const initialPosition = [14.734902, 120.987555]
            const zoom = 18

            // SOCKET IO
            const socket = io('http://localhost:5345')
	        socket.on("connection");

            socket.on("addData", function(data) {
                const payload = data["payload"].split("*");

                var marker = L.marker([payload[1], payload[2]]).addTo(map);
                // marker.bindPopup(`DEVICE ID - ${payload[0]}`).openPopup();

                marker.on('click', function() {
                    showModal(payload);
                });

                
            });


            socket.on("new_location", function(data) {                              
                getData();
            });
            
            // All OpenStreetMap Testing

            //Map Variable
            var map = L.map('map');
            map.setView(initialPosition, zoom)

            const clearMap = () => {
                map.eachLayer(function (layer) {
                    if (layer instanceof L.Marker) {
                        map.removeLayer(layer);
                    }
                });

                console.log("Gumana, pre!");
            }

            const getData = async () => {
                fetch('/testdata/getCoordinates?cache-buster=' + Date.now())
                    .then(response => response.json())
                    .then(data => {
                        clearMap();
                        console.log(data);
                        data.map((coor) => {
                            const payload = coor.payload.split("*");

                            var marker = L.marker([payload[1], payload[2]]).addTo(map);
                            // marker.bindPopup(`DEVICE ID - ${payload[0]}`).openPopup();
                            marker.on('click', function() {
                                showModal(payload);
                            });
                        })
                    })
                    .catch(error => {
                        console.error(error);
                    });
            }

            const getDetails = async (clientId) => {
                fetch('/testData/getDetails?clientId=' + clientId)
                    .then(response => response.json())
                    .then(data => {
                        console.log(data);
                        updateModalInfo(data);
                    })
                    .catch(error => {
                        console.error(error);
                    });
            }

            var coors = getData();
            

            //Tile Layer
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            //Map Attribution
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            //Popups 
            
            var popup = L.popup();


            function onMapClick(e) {
                popup
                .setLatLng(e.latlng)
                .setContent("The coordinates are as follow " + e.latlng.toString())
                .openOn(map);
            }
            
            map.on('click', onMapClick);

            function showModal(payload) {
                var div = document.getElementById("info-modal");
                var location_element = document.getElementById("modal_location");
                var client_id_element = document.getElementById("modal_clientId");

                var clientId = payload[0];
                var location = `${payload[1]}, ${payload[2]}`

                getDetails(clientId);

                div.style.display = "block";
                location_element.textContent = location; 
                client_id_element.textContent = clientId; 


            }

            function updateModalInfo(data) {
                if (!data) {
                    return;
                }
                const payload = data["payload"].split("*");
                var name = payload[1];
                var number = payload[2];
                var emergency = payload[3];
                var needs = payload[3];
                var dangers = payload[3];
                var num_people = payload[3];
                var immobile = payload[3];
                var message = payload[3];
                
            }

        </script>

    </body>


</html>
